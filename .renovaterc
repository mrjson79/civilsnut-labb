{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "description": "Renovate configuration for civilsnut-labbet Kubernetes cluster",

  // Base configuration
  "extends": [
    "config:base",
    ":dependencyDashboard",
    ":semanticCommits",
    ":automergeDigest",
    ":automergeBranch"
  ],

  // Scheduling
  "timezone": "Europe/Stockholm",
  "schedule": ["before 6am on monday"],
  "prConcurrentLimit": 10,
  "prHourlyLimit": 5,

  // Update strategy
  "separateMinorPatch": true,
  "separateMajorMinor": true,
  "separateMultipleMajor": true,
  "platformAutomerge": true,

  // Git configuration
  "gitAuthor": "Renovate Bot <renovate@civilsnut.com>",
  "commitMessagePrefix": "chore:",
  "commitMessageTopic": "{{depName}}",
  "commitMessageExtra": "to {{newVersion}}",
  "prTitle": "{{commitMessagePrefix}} {{commitMessageAction}} {{commitMessageTopic}} {{commitMessageExtra}}",

  // Labels and assignees
  "labels": ["dependencies"],
  "assignees": ["mrjson79"],
  "reviewers": ["mrjson79"],

  // Vulnerability alerts
  "vulnerabilityAlerts": {
    "labels": ["security", "dependencies"],
    "assignees": ["mrjson79"],
    "reviewers": ["mrjson79"],
    "schedule": ["at any time"]
  },

  // Manager configurations
  "kubernetes": {
    "fileMatch": ["\\.ya?ml$"]
  },

  "argocd": {
    "fileMatch": ["argocd/.+\\.ya?ml$"]
  },

  "flux": {
    "fileMatch": ["fluxcd/.+\\.ya?ml$"]
  },

  "helm-values": {
    "fileMatch": [
      "values\\.ya?ml$",
      "values/.+\\.ya?ml$"
    ]
  },

  // Package-specific rules
  "packageRules": [
    {
      "description": "Critical security components - require manual review",
      "matchPackageNames": ["cert-manager", "argo-cd", "longhorn"],
      "automerge": false,
      "labels": ["security-critical"],
      "reviewers": ["mrjson79"],
      "assignees": ["mrjson79"]
    },

    {
      "description": "Storage systems - careful review needed",
      "matchPackageNames": ["longhorn", "csi-*"],
      "labels": ["storage"],
      "automerge": false,
      "reviewers": ["mrjson79"]
    },

    {
      "description": "Networking components - test thoroughly",
      "matchPackageNames": ["cilium", "ingress-nginx", "traefik"],
      "labels": ["networking"],
      "automerge": false,
      "groupName": "Networking Stack"
    },

    {
      "description": "Monitoring and observability stack",
      "matchPackageNames": ["kube-prometheus-stack", "prometheus", "grafana", "alertmanager"],
      "labels": ["monitoring"],
      "groupName": "Monitoring Stack",
      "schedule": ["before 6am on saturday"]
    },

    {
      "description": "Home automation components",
      "matchPackageNames": ["home-assistant", "zigbee2mqtt", "mqtt"],
      "labels": ["home-automation"],
      "groupName": "Home Automation",
      "schedule": ["before 6am on sunday"]
    },

    {
      "description": "FluxCD Infrastructure Components",
      "matchPackageNames": ["cilium", "cert-manager", "ingress-nginx"],
      "labels": ["infrastructure", "fluxcd"],
      "groupName": "Infrastructure Stack",
      "automerge": false,
      "schedule": ["before 6am on saturday"]
    },

    {
      "description": "FluxCD Storage and Security",
      "matchPackageNames": ["longhorn", "external-secrets", "connect"],
      "labels": ["storage", "security", "fluxcd"],
      "groupName": "Storage & Security",
      "automerge": false,
      "schedule": ["before 6am on saturday"]
    },

    {
      "description": "Container images - patch updates can be auto-merged",
      "matchDatasources": ["docker"],
      "matchUpdateTypes": ["patch", "digest"],
      "automerge": true,
      "automergeType": "branch",
      "labels": ["container-images", "automerge"]
    },

    {
      "description": "Helm chart minor updates",
      "matchDatasources": ["helm"],
      "matchUpdateTypes": ["minor"],
      "labels": ["helm", "minor-update"],
      "reviewers": ["mrjson79"]
    },

    {
      "description": "Major updates require careful review",
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "labels": ["major-update"],
      "reviewers": ["mrjson79"],
      "assignees": ["mrjson79"],
      "prPriority": 10
    },

    {
      "description": "Security updates have highest priority",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["alpine", "ubuntu", "debian"],
      "labels": ["base-images", "security"],
      "prPriority": 20,
      "schedule": ["at any time"]
    }
  ],

  // Custom regex managers for specific patterns
  "regexManagers": [
    {
      "description": "Helm chart versions in ArgoCD applications",
      "fileMatch": ["argocd/apps/.+\\.ya?ml$"],
      "matchStrings": [
        "chart: (?<depName>[^\\s]+)\\s+repoURL: (?<registryUrl>[^\\s]+)\\s+targetRevision: (?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "helm"
    },

    {
      "description": "Container images in Kubernetes manifests",
      "fileMatch": ["\\.ya?ml$"],
      "matchStrings": [
        "image:\\s*[\"']?(?<depName>[^@\\s\"']+)(?:@(?<currentDigest>sha256:[a-f0-9]+)|:(?<currentValue>[^\\s\"']+))[\"']?"
      ],
      "datasourceTemplate": "docker"
    },

    {
      "description": "Git repository versions in ArgoCD",
      "fileMatch": ["argocd/.+\\.ya?ml$"],
      "matchStrings": [
        "repoURL: https://github\\.com/(?<depName>[^/]+/[^/]+)\\.git\\s+targetRevision: (?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "github-releases"
    },

    {
      "description": "FluxCD HelmRelease chart versions",
      "fileMatch": ["^fluxcd/.+/release\\.ya?ml$"],
      "matchStrings": [
        "kind: HelmRelease[\\s\\S]*?chart:\\s*(?<depName>[^\\s]+)[\\s\\S]*?version:\\s*[\"'](?<currentValue>[^\"']+)[\"']"
      ],
      "datasourceTemplate": "helm"
    }
  ],

  // Host rules for timeout and authentication
  "hostRules": [
    {
      "matchHost": "charts.jetstack.io",
      "timeout": 30000
    },
    {
      "matchHost": "charts.longhorn.io",
      "timeout": 30000
    },
    {
      "matchHost": "argoproj.github.io",
      "timeout": 30000
    },
    {
      "matchHost": "prometheus-community.github.io",
      "timeout": 30000
    },
    {
      "matchHost": "helm.cilium.io",
      "timeout": 30000
    },
    {
      "matchHost": "charts.external-secrets.io",
      "timeout": 30000
    },
    {
      "matchHost": "kubernetes.github.io",
      "timeout": 30000
    },
    {
      "matchHost": "1password.github.io",
      "timeout": 30000
    },
    {
      "matchHost": "charts.zigbee2mqtt.io",
      "timeout": 30000
    }
  ],

  // Ignore certain dependencies or patterns
  "ignoreDeps": [
    // Ignore local development images
    "localhost/**",
    // Ignore specific tags that shouldn't be updated
    "*:latest",
    "*:main"
  ],

  // Force specific versions for critical components
  "allowedVersions": {
    "kubernetes": "< 1.30.0",
    "cert-manager": "< 2.0.0"
  }
}
