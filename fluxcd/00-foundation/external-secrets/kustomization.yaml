apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  annotations:
    # Ensure external-secrets CRDs and operator are fully ready
    flux.weave.works/prune: "false"
    kustomize.toolkit.fluxcd.io/timeout: "10m"

resources:
  - namespace.yaml
  - repository.yaml
  - release.yaml

# Add common labels for foundation phase
commonLabels:
  deployment.phase: "foundation"
  deployment.component: "external-secrets"

# Health checks to ensure external-secrets is ready before dependents
healthChecks:
  - apiVersion: apps/v1
    kind: Deployment
    name: external-secrets
    namespace: external-secrets
  - apiVersion: apps/v1
    kind: Deployment
    name: external-secrets-webhook
    namespace: external-secrets
  - apiVersion: apps/v1
    kind: Deployment
    name: external-secrets-cert-controller
    namespace: external-secrets
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: externalsecrets.external-secrets.io
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: secretstores.external-secrets.io
